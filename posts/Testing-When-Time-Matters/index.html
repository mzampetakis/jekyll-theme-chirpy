<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Testing When Time Matters" /><meta property="og:locale" content="en_US" /><meta name="description" content="Mocking out time sensitivity from unit tests." /><meta property="og:description" content="Mocking out time sensitivity from unit tests." /><link rel="canonical" href="https://mzampetakis.com/posts/Testing-When-Time-Matters/" /><meta property="og:url" content="https://mzampetakis.com/posts/Testing-When-Time-Matters/" /><meta property="og:site_name" content="Michalis Zampetakis" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-09-26T20:55:00+03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Testing When Time Matters" /><meta name="twitter:site" content="@mzampetakis" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"Mocking out time sensitivity from unit tests.","url":"https://mzampetakis.com/posts/Testing-When-Time-Matters/","@type":"BlogPosting","headline":"Testing When Time Matters","dateModified":"2021-07-01T22:16:00+03:00","datePublished":"2020-09-26T20:55:00+03:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mzampetakis.com/posts/Testing-When-Time-Matters/"},"@context":"https://schema.org"}</script><title>Testing When Time Matters | Michalis Zampetakis</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Michalis Zampetakis"><meta name="application-name" content="Michalis Zampetakis"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-172730569-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-172730569-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/sample/mz2.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Michalis Zampetakis</a></div><div class="site-subtitle font-italic">Curiosity Driven</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/now/" class="nav-link"> <i class="fa-fw fas fa-clock ml-xl-3 mr-xl-3 unloaded"></i> <span>NOW</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/mzampetakis" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/mzampetakis" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['mzampetakis','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Testing When Time Matters</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Testing When Time Matters</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Michalis Zampetakis </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Sep 26, 2020, 8:55 PM +0300" prep="on" > Sep 26, 2020 <i class="unloaded">2020-09-26T20:55:00+03:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Jul 1, 2021, 10:16 PM +0300" prefix="Updated " > Jul 1 <i class="unloaded">2021-07-01T22:16:00+03:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1425 words">7 min</span></div></div><div class="post-content"> <img src="/assets/posts/Testing-When-Time-Matters/time.jpg" class="preview-img" alt="Preview Image"><p>Software testing undeniably can provide objective, independent information about the quality of software. However, the testing development process can sometimes be not straightforward. There are cases - not so rare - that the development of a test requires a significant amount of effort and time. One of these cases is when we have to test code that is dependant on the current time.</p><h2 id="the-issue">The issue</h2><p>Developing processes that depend on the current time or elapsed time is not a rare case. There are many cases we need to use the current time and diverse a program’s execution depending on time, duration, or a period. A few examples are schedulers, expirations, repetitive tasks, timeouts, and more…</p><p>A sample case of a library in Go that is dependant on time is a key-value store that uses expiration on each pair. Such a Store should have the following structure</p><div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">type</span> <span class="n">DataStore</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Data</span>            <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="n">mapValue</span>
	<span class="n">DeletePrecision</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">MapValue</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Expiration</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span>
	<span class="n">Value</span>      <span class="k">interface</span><span class="p">{}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Each store has a <code class="language-plaintext highlighter-rouge">deletePrecision</code> duration which signifies the amount of time that it checks for expired data. Also <code class="language-plaintext highlighter-rouge">mapValue.expiration</code> is a <code class="language-plaintext highlighter-rouge">time.Time</code> which signifies the expiration of each <code class="language-plaintext highlighter-rouge">mapValue.value</code> that is added in the <code class="language-plaintext highlighter-rouge">DataStore</code>.</p><p>A function that checks and deletes expired <code class="language-plaintext highlighter-rouge">mapValues</code> could Periodically run every <code class="language-plaintext highlighter-rouge">deletePrecision</code> duration as seen bellow:</p><div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="p">(</span><span class="n">ds</span> <span class="o">*</span><span class="n">DataStore</span><span class="p">)</span> <span class="n">DeleteExpiredKeys</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">checkIntervalTicker</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">NewTicker</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">DeletePrecision</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="o">&lt;-</span> <span class="n">checkIntervalTicker</span><span class="o">.</span><span class="n">C</span>    <span class="c">// every ds.deletePrecision duration</span>
		<span class="n">ds</span><span class="o">.</span><span class="n">checkAndDeleteExpiredKeys</span><span class="p">()</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">ds</span> <span class="o">*</span><span class="n">DataStore</span><span class="p">)</span> <span class="n">checkAndDeleteExpiredKeys</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">ds</span><span class="o">.</span><span class="n">Data</span> <span class="p">{</span>
		<span class="n">now</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">Expiration</span><span class="o">.</span><span class="n">Before</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="p">{</span>
			<span class="nb">delete</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>So, when we need to test <code class="language-plaintext highlighter-rouge">checkAndDeleteExpiredKeys()</code> function we face an issue. Our function depends on an uncontrollable resource:</p><p><strong>Current Time</strong></p><p>This means that when we have to write a test for the <code class="language-plaintext highlighter-rouge">checkAndDeleteExpiredKeys()</code> function we should appropriately set up a mapValue object with an expiration, check the time elapsed and then run the <code class="language-plaintext highlighter-rouge">checkAndDeleteExpiredKeys()</code> function before any assertion. This leaves us to have a test with some sleeping time in order to avoid any false negatives in our test:</p><div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="n">TestCheckAndDeleteExpiredKeys</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ds</span> <span class="o">:=</span> <span class="n">DataStore</span><span class="p">{</span>
		<span class="n">Data</span><span class="o">:</span>            <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="n">mapValue</span><span class="p">{},</span>
		<span class="n">DeletePrecision</span><span class="o">:</span> <span class="n">precision</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">Data</span><span class="p">[</span><span class="s">"akey"</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapValue</span><span class="p">{</span>
        <span class="n">expiration</span><span class="o">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">Clock</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">500</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span><span class="p">),</span>
		<span class="n">value</span><span class="o">:</span>      <span class="s">"avalue"</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">300</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">checkAndDeleteExpiredKeys</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">_</span><span class="p">,</span> <span class="n">exists</span> <span class="o">:=</span> <span class="n">ds</span><span class="o">.</span><span class="n">Data</span><span class="p">[</span><span class="s">"akey"</span><span class="p">]</span> <span class="p">;</span> <span class="o">!</span><span class="n">exists</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Key-value not found but should"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">300</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">checkAndDeleteExpiredKeys</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">_</span><span class="p">,</span> <span class="n">exists</span> <span class="o">:=</span> <span class="n">ds</span><span class="o">.</span><span class="n">Data</span><span class="p">[</span><span class="s">"akey"</span><span class="p">]</span> <span class="p">;</span> <span class="n">exists</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Key-value found but shouldn't"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Looking into this test it is clear that, adding a delay in our test to verify the correctness of a function, is not a desirable process at all. Apart from the fact that our unit test now adds an extra delay to the testing process, it is clear that trying to minimize this delay might affect our test. Also, this way of testing makes our test less easy to maintain and more prone to errors.</p><h3 id="some-theory">Some theory</h3><p>As seen above our function is tightly coupled with a resource we don’t have control on. <strong>Current time</strong>. Decoupling our function from this external resource is essential for unit testing.</p><p>The most common way to achieve this decoupling is by using Dependency Injection (DI).</p><p>According to <a href="https://en.wikipedia.org/wiki/Dependency_injection">Wikipedia</a>:</p><blockquote><p>In software engineering, dependency injection is a technique in which an object receives other objects that it depends on. These other objects are called dependencies. In the typical “using” relationship the receiving object is called a client and the passed (that is, “injected”) object is called a service. The code that passes the service to the client can be many kinds of things and is called the injector. Instead of the client specifying which service it will use, the injector tells the client what service to use. The “injection” refers to the passing of a dependency (a service) into the object (a client) that would use it. Dependency injection is one form of the broader technique of inversion of control. A client who wants to call some services should not have to know how to construct those services. Instead, the client delegates the responsibility of providing its services to external code (the injector).</p></blockquote><p>But the intent of this technique is this:</p><blockquote><p>The intent behind dependency injection is to achieve separation of concerns of construction and use of objects. This can increase readability and code reusability.</p></blockquote><h2 id="the-solution">The solution</h2><p>Coming back to our case, we should now follow the separation of concerns through DI in our scenario, in order to give us the ability to test our function. This means we should provide each DataStore object with an interface that implements a <code class="language-plaintext highlighter-rouge">Now()</code> function. This should return the current time in all cases but when we are testing our <code class="language-plaintext highlighter-rouge">checkAndDeleteExpiredKeys()</code> function we could override it.</p><p>So, <code class="language-plaintext highlighter-rouge">Datastore</code> should now have the following form:</p><div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">type</span> <span class="n">DataStore</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">Data</span>            <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="n">mapValue</span>
    <span class="n">DeletePrecision</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span>
    <span class="n">Clock</span>           <span class="n">Clock</span>
<span class="p">}</span>

<span class="c">// Clock is an interface that provides a single function</span>
<span class="c">// to return the current time which is used for checking expiration.</span>
<span class="k">type</span> <span class="n">Clock</span> <span class="k">interface</span> <span class="p">{</span>
	<span class="n">Now</span><span class="p">()</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The default SystemClock provided below could be used by default in each New <code class="language-plaintext highlighter-rouge">Datastore</code>:</p><div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c">// SystemClock implements Clock interface that uses time.Now().</span>
<span class="k">var</span> <span class="n">SystemClock</span> <span class="o">=</span> <span class="n">systemClock</span><span class="p">{}</span>

<span class="k">type</span> <span class="n">systemClock</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">t</span> <span class="n">systemClock</span><span class="p">)</span> <span class="n">Now</span><span class="p">()</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="p">}</span>
</pre></table></code></div></div><p>However, during our unit test, we can inject an implementation of the <code class="language-plaintext highlighter-rouge">Clock interface</code> that we could control the <code class="language-plaintext highlighter-rouge">Now()</code> function’s results so that we can alter the “current” time based on the test!<br /> So our test can now be formed like this:</p><div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="k">type</span> <span class="n">pastClock</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">var</span> <span class="n">PastClock</span> <span class="o">=</span> <span class="n">pastClock</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">t</span> <span class="n">pastClock</span><span class="p">)</span> <span class="n">Now</span><span class="p">()</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span> <span class="p">{</span>
	<span class="n">pt</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">RFC3339</span><span class="p">,</span> <span class="s">"2000-01-01T00:00:00+00:00"</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">pt</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">futureClock</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">var</span> <span class="n">FutureClock</span> <span class="o">=</span> <span class="n">futureClock</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">t</span> <span class="n">futureClock</span><span class="p">)</span> <span class="n">Now</span><span class="p">()</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span> <span class="p">{</span>
	<span class="n">pt</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">RFC3339</span><span class="p">,</span> <span class="s">"3000-01-01T00:00:00+00:00"</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">pt</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestCheckAndDeleteExpiredKeys</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ds</span> <span class="o">:=</span> <span class="n">DataStore</span><span class="p">{</span>
		<span class="n">Data</span><span class="o">:</span>            <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="n">mapValue</span><span class="p">{},</span>
        <span class="n">DeletePrecision</span><span class="o">:</span> <span class="n">precision</span><span class="p">,</span>
        <span class="n">Clock</span><span class="o">:</span> <span class="n">PastClock</span>
    <span class="p">}</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">Data</span><span class="p">[</span><span class="s">"akey"</span><span class="p">]</span><span class="o">=</span><span class="n">mapValue</span><span class="p">{</span>
		<span class="n">expiration</span><span class="o">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">Clock</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">500</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span><span class="p">),</span>
		<span class="n">value</span><span class="o">:</span>      <span class="s">"avalue"</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">checkAndDeleteExpiredKeys</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">_</span><span class="p">,</span> <span class="n">exists</span> <span class="o">:=</span> <span class="n">ds</span><span class="o">.</span><span class="n">Data</span><span class="p">[</span><span class="s">"akey"</span><span class="p">]</span> <span class="p">;</span> <span class="o">!</span><span class="n">exists</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Key-value not found but should"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">Clock</span> <span class="o">=</span> <span class="n">FutureClock</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">checkAndDeleteExpiredKeys</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">_</span><span class="p">,</span> <span class="n">exists</span> <span class="o">:=</span> <span class="n">ds</span><span class="o">.</span><span class="n">Data</span><span class="p">[</span><span class="s">"akey"</span><span class="p">]</span> <span class="p">;</span> <span class="n">exists</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Key-value found but shouldn't"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>In the test above, we generated two different implementors of the <code class="language-plaintext highlighter-rouge">Clock</code> interface: one providing a past time and one providing a future time. This provides to our test the ability to change between those two in between the assertions leaving the test with no possibility to create a false positive or negative and also without adding any extra delay.</p><blockquote><p>We could also use more fine-grained results in <code class="language-plaintext highlighter-rouge">Now()</code> functions of the two implementations in order to give a more precise result (in our case 500ms are enough!) between those two implementations.</p></blockquote><h2 id="other-approaches">Other Approaches</h2><p>It might be a little weird to Inject a Dependency in our library that will only be used while unit testing some of the provided functionalities. However, this is an essential process when we want to achieve such a decoupling.</p><p>Another commonly process that is using when we have to test a function which requires a resource that we do not control in <strong>Monkey Patching</strong> (or mocking).</p><blockquote><p>Mocking is primarily used in unit testing. An object under test may have dependencies on other (complex) objects. To isolate the behavior of the object you want to replace the other objects by mocks that simulate the behavior of the real objects. This is useful if the real objects are impractical to incorporate into the unit test.</p><p>In short, mocking is creating objects that simulate the behavior of real objects.</p></blockquote><p>In our case we could use one of the available mocking libraries. Some of theme are listed bellow:</p><ul><li><a href="https://github.com/golang/mock">mock</a><li><a href="https://github.com/stretchr/testify">testify</a><li><a href="https://github.com/bouk/monkey">monkey</a></ul><h2 id="wrap-up">Wrap up</h2><p>Decoupling a function from it’s external resources is essential for unit testing. Dependency Injection is the technique that we usually exploit to achieve this decoupling. In our case we showed how to test a function that uses current time and injected it to the function under test. Monkey patching is another commonly pattern used when it comes to test resources we do not own. So, choose your preferred one and keep testing!</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/golang/" class="post-tag no-text-decoration" >golang</a> <a href="/tags/testing/" class="post-tag no-text-decoration" >testing</a> <a href="/tags/time/" class="post-tag no-text-decoration" >time</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Testing When Time Matters - Michalis Zampetakis&url=https://mzampetakis.com/posts/Testing-When-Time-Matters/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Testing When Time Matters - Michalis Zampetakis&u=https://mzampetakis.com/posts/Testing-When-Time-Matters/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Testing When Time Matters - Michalis Zampetakis&url=https://mzampetakis.com/posts/Testing-When-Time-Matters/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Hello-Blog/">Hello Blog</a><li><a href="/posts/Log-Requests-in-Go/">Log Requests in Go</a><li><a href="/posts/AquaGo-A-Toy-Project/">AquaGo - A Toy Project</a><li><a href="/posts/Testing-When-Time-Matters/">Testing When Time Matters</a><li><a href="/posts/Deep-Dive-in-Go-Channels/">Deep Dive in Go Channels</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/golang/">golang</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/blogging/">blogging</a> <a class="post-tag" href="/tags/image-processing/">image-processing</a> <a class="post-tag" href="/tags/lego/">LEGO</a> <a class="post-tag" href="/tags/oauth/">oAuth</a> <a class="post-tag" href="/tags/shell/">shell</a> <a class="post-tag" href="/tags/testing/">testing</a> <a class="post-tag" href="/tags/time/">time</a> <a class="post-tag" href="/tags/toy-project/">toy-project</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Log-Requests-in-Go/"><div class="card-body"> <span class="timeago small" > Aug 17, 2020 <i class="unloaded">2020-08-17T23:40:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Log Requests in Go</h3><div class="text-muted small"><p> It’s a common sense that logging your HTTP request in your application is essential. The reasons for doing so are numerous. Error reporting, tracing, monitoring, performance tuning and so on. One ...</p></div></div></a></div><div class="card"> <a href="/posts/AquaGo-A-Toy-Project/"><div class="card-body"> <span class="timeago small" > Aug 31, 2020 <i class="unloaded">2020-08-31T22:40:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AquaGo - A Toy Project</h3><div class="text-muted small"><p> Just imagine if you could have on your living’s room TV an aquarium! Wouldn’t that be nice, especially during the hot period of summertime? What about if you could add digital fishes and decorative...</p></div></div></a></div><div class="card"> <a href="/posts/Deep-Dive-in-Go-Channels/"><div class="card-body"> <span class="timeago small" > Oct 31, 2020 <i class="unloaded">2020-10-31T07:55:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Deep Dive in Go Channels</h3><div class="text-muted small"><p> One of the biggest advantages of Go is undoubtedly it’s concurrency management. Goroutines are the main feature that Go uses to achieve this. Goroutines wouldn’t be so easy if there wasn’t for chan...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/AquaGo-A-Toy-Project/" class="btn btn-outline-primary" prompt="Older"><p>AquaGo - A Toy Project</p></a> <a href="/posts/Deep-Dive-in-Go-Channels/" class="btn btn-outline-primary" prompt="Newer"><p>Deep Dive in Go Channels</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//mzampetakis.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Testing When Time Matters'; this.page.url = 'https://mzampetakis.com/posts/Testing-When-Time-Matters/'; this.page.identifier = '/posts/Testing-When-Time-Matters/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://mzampetakis.com">Michalis Zampetakis</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/golang/">golang</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/blogging/">blogging</a> <a class="post-tag" href="/tags/image-processing/">image processing</a> <a class="post-tag" href="/tags/lego/">LEGO</a> <a class="post-tag" href="/tags/oauth/">oAuth</a> <a class="post-tag" href="/tags/shell/">shell</a> <a class="post-tag" href="/tags/testing/">testing</a> <a class="post-tag" href="/tags/time/">time</a> <a class="post-tag" href="/tags/toy-project/">toy project</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://mzampetakis.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
